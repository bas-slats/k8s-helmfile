# Grafana configuration
# Unified observability UI

replicas: 1

resources:
  requests:
    cpu: 50m
    memory: 128Mi
  limits:
    memory: 512Mi

# Persistence
persistence:
  enabled: true
  storageClassName: local-path
  size: 5Gi

# Admin credentials - change these!
adminUser: admin
# adminPassword: set via external secret or env

# Datasources - pre-configured for observability stack
datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
      # Mimir for metrics (Prometheus-compatible)
      - name: Mimir
        type: prometheus
        uid: mimir
        url: http://mimir-nginx.mimir.svc.cluster.local:80/prometheus
        access: proxy
        isDefault: true
        jsonData:
          httpMethod: POST
          timeInterval: "15s"

      # Tempo for traces
      - name: Tempo
        type: tempo
        uid: tempo
        url: http://tempo.tempo.svc.cluster.local:3100
        access: proxy
        jsonData:
          httpMethod: GET
          tracesToLogsV2:
            datasourceUid: loki
            spanStartTimeShift: '-1h'
            spanEndTimeShift: '1h'
            filterByTraceID: true
            filterBySpanID: true
          tracesToMetrics:
            datasourceUid: mimir
          tracesToProfiles:
            datasourceUid: pyroscope
          lokiSearch:
            datasourceUid: loki
          nodeGraph:
            enabled: true
          serviceMap:
            datasourceUid: mimir

      # Loki for logs
      - name: Loki
        type: loki
        uid: loki
        url: http://loki.loki.svc.cluster.local:3100
        access: proxy
        jsonData:
          derivedFields:
            - datasourceUid: tempo
              matcherRegex: '"traceId":"(\w+)"'
              name: TraceID
              url: '$${__value.raw}'

      # Pyroscope for profiling
      - name: Pyroscope
        type: grafana-pyroscope-datasource
        uid: pyroscope
        url: http://pyroscope.pyroscope.svc.cluster.local:4040
        access: proxy

# Dashboard providers
dashboardProviders:
  dashboardproviders.yaml:
    apiVersion: 1
    providers:
      - name: 'default'
        orgId: 1
        folder: ''
        type: file
        disableDeletion: false
        editable: true
        options:
          path: /var/lib/grafana/dashboards/default

# Pre-installed dashboards - add configmaps as needed
# dashboardsConfigMaps:
#   default: "grafana-dashboards"

# Plugins - pyroscope is now a core plugin in Grafana 11.x
plugins:
  - grafana-lokiexplore-app

# Grafana configuration
grafana.ini:
  server:
    root_url: "%(protocol)s://%(domain)s/"
  analytics:
    reporting_enabled: false
    check_for_updates: false
  security:
    disable_gravatar: true
  users:
    allow_sign_up: false
  auth:
    disable_login_form: false
  feature_toggles:
    enable: traceToProfiles traceToMetrics correlations
